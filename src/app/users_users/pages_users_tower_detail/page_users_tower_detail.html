<article class="tower-detail-page">
  <header class="content-header">
    <div class="header-layout">
      <section class="header-info">
        <h2>{{ tower()?.name ?? 'Tower' }} Flats</h2>
        <p>Browse flat inventory and availability.</p>
      </section>
      <div class="header-actions-block">
        <div class="header-meta-actions">
          @if (building()) {
            <button
              type="button"
              class="view-btn header-inline-btn icon-btn"
              (click)="openAmenitiesModal()"
              aria-label="View amenities"
              title="View amenities"
            >
              <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <path
                  fill="currentColor"
                  d="M3 3h8v8H3zm10 0h8v8h-8zM3 13h8v8H3zm10 0h8v8h-8z"
                />
              </svg>
              <span class="btn-label">View Amenities</span>
            </button>
          }
          <a
            class="action-btn ghost header-inline-btn icon-btn"
            [routerLink]="['/users/buildings', buildingId(), 'towers']"
            [attr.title]="'Go back to ' + (building()?.name ?? 'Building') + ' towers'"
            aria-label="Go back to towers"
          >
            <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path fill="currentColor" d="M14 7l-5 5 5 5 1.4-1.4L11.8 12l3.6-3.6zM20 11H10v2h10z" />
            </svg>
            <span class="btn-label">Go Back to Towers</span>
          </a>
        </div>
      </div>
    </div>
  </header>

  @if (error()) {
    <section class="state-card error">
      <p>{{ error() }}</p>
    </section>
  }

  @if (flatsData().length === 0 && !isLoading() && !error()) {
    <section class="state-card">
      <p>No flats found for this tower.</p>
    </section>
  }

  @if (isLoading()) {
    <section class="flats-list">
      @for (item of [1, 2, 3]; track item) {
        <article class="flat-card">
          <div>
            <div class="skeleton-block skeleton-line lg"></div>
          </div>
          <div class="skeleton-block skeleton-image"></div>
          <div>
            <div class="skeleton-block skeleton-line"></div>
            <div class="skeleton-block skeleton-line"></div>
          </div>
        </article>
      }
    </section>
  }

  <section class="flats-list">
    @for (flat of flatsData(); track flat.id) {
      <article
        class="flat-card"
        role="button"
        tabindex="0"
        (click)="openFlatDetail(flat.id)"
        (keydown.enter)="openFlatDetail(flat.id)"
        (keydown.space)="openFlatDetail(flat.id); $event.preventDefault()"
        aria-label="Open details for flat {{ flat.flat_number }}"
      >
        <h3 class="flat-title">{{ flat.flat_number }}</h3>
        @if (flat.picture_url) {
          <img class="flat-image" [src]="flat.picture_url" [alt]="flat.flat_number + ' flat image'" />
        } @else {
          <div class="flat-image-placeholder">No Image</div>
        }

        <div class="flat-content">
          <div class="flat-meta-table">
            <p><span>Flat Number</span><strong>{{ flat.flat_number }}</strong></p>
            <p><span>Floor</span><strong>{{ flat.floor_number }}</strong></p>
            <p><span>BHK Type</span><strong>{{ flat.bhk_type }}</strong></p>
            <p><span>Area</span><strong>{{ flat.area_sqft }} sqft</strong></p>
            <p><span>Rent</span><strong>Rs {{ flat.rent_amount }}</strong></p>
            <p><span>Security Deposit</span><strong>Rs {{ flat.security_deposit }}</strong></p>
            <p><span>Status</span><strong class="status-chip" [class.available]="flat.is_available" [class.unavailable]="!flat.is_available">{{ flat.is_available ? 'Available' : 'Not Available' }}</strong></p>
          </div>
        </div>
      </article>
    }
  </section>
</article>

@if (isAmenitiesModalOpen()) {
  <section class="modal-backdrop" (click)="closeAmenitiesModal()">
    <article class="action-modal amenities-modal" (click)="$event.stopPropagation()">
      <header class="modal-header">
        <h3>{{ building()?.name ?? 'Building' }} Amenities</h3>
        <button type="button" class="view-btn ghost" (click)="closeAmenitiesModal()">Close</button>
      </header>
      <div class="modal-content">
        @if (isAmenitiesModalLoading()) {
          <div>
            <div class="skeleton-block skeleton-line lg"></div>
            <div class="skeleton-block skeleton-line"></div>
            <div class="skeleton-block skeleton-image"></div>
          </div>
        }

        @if (amenitiesModalError()) {
          <p class="error-text">{{ amenitiesModalError() }}</p>
        }

        @if (!isAmenitiesModalLoading() && !amenitiesModalError() && amenitiesModalData().length === 0) {
          <p class="amenity-desc">No amenities found for this building.</p>
        }

        @if (amenitiesModalData().length > 0) {
          <p class="building-name-line"><strong>Building:</strong> {{ building()?.name ?? 'N/A' }}</p>
          <div class="amenities-list">
            @for (amenity of amenitiesModalData(); track amenity.name + '-' + $index) {
              <article class="amenity-card">
                @if (amenity.picture_url) {
                  <img class="amenity-image" [src]="amenity.picture_url" [alt]="amenity.name + ' image'" />
                } @else {
                  <div class="amenity-image-placeholder">No Image</div>
                }

                <div class="amenity-content">
                  <h4>{{ amenity.name }}</h4>
                  <p class="amenity-description"><strong>Description:</strong> {{ amenity.description ?? 'No description' }}</p>
                </div>
              </article>
            }
          </div>
        }
      </div>
    </article>
  </section>
}
