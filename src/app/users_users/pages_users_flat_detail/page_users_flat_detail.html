<article class="flat-detail-page">
  <header class="content-header">
    <div class="header-layout">
      <section class="header-info">
        <h2>{{ flat()?.flat_number ?? 'Flat' }}</h2>
        <p>Flat details and booking</p>
      </section>
      <div class="header-actions-block">
        <div class="header-meta-actions">
          <a
            class="action-btn ghost header-inline-btn icon-btn"
            [routerLink]="['/users/buildings', buildingId(), 'towers', towerId()]"
            [attr.title]="'Back to ' + (tower()?.name ?? 'Tower')"
            aria-label="Back to tower"
          >
            <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path fill="currentColor" d="M14 7l-5 5 5 5 1.4-1.4L11.8 12l3.6-3.6zM20 11H10v2h10z" />
            </svg>
            <span class="btn-label">Back to <span class="back-label">{{ tower()?.name ?? 'Tower' }}</span></span>
          </a>
          <button
            type="button"
            class="action-btn primary header-inline-btn icon-btn"
            (click)="openBookingModal()"
            [disabled]="flat()?.is_available === false || hasAlreadyBookedThisFlat()"
            aria-label="Book flat"
            title="Book flat"
          >
            <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path fill="currentColor" d="M7 2h2v2h6V2h2v2h3v18H4V4h3zm11 6H6v12h12V8zm-8 2h4v2h-4v-2z" />
            </svg>
            <span class="btn-label">
              {{
                hasAlreadyBookedThisFlat()
                  ? 'User Already Booked The Flat'
                  : (flat()?.is_available === false ? 'Flat Not Available' : 'Book Flat')
              }}
            </span>
          </button>
        </div>
      </div>
    </div>
  </header>

  @if (error()) {
    <section class="state-card error">
      <p>{{ error() }}</p>
    </section>
  }

  @if (isLoading()) {
    <section class="state-card">
      <div class="skeleton-block skeleton-line lg"></div>
      <div class="skeleton-block skeleton-line"></div>
      <div class="skeleton-block skeleton-image"></div>
    </section>
  }

  <section class="flat-location-section">
    <div class="flat-location-table">
      <p>
        <span>Tower</span>
        <strong>
          <a class="entity-link" [routerLink]="['/users/buildings', buildingId(), 'towers', towerId()]">
            {{ tower()?.name ?? 'Tower' }}
          </a>
        </strong>
      </p>
      <p>
        <span>Building</span>
        <strong>
          <a class="entity-link" [routerLink]="['/users/buildings', buildingId(), 'towers']">
            {{ building()?.name ?? 'Building' }}
          </a>
        </strong>
      </p>
      <p>
        <span>Address</span>
        <strong>{{ building()?.full_address ?? ((building()?.address ?? '') + ', ' + (building()?.city ?? '') + ', ' + (building()?.state ?? '') + ', ' + (building()?.pincode ?? '')) }}</strong>
      </p>
    </div>
  </section>

  <section class="flat-images-section">
    <header class="section-header flat-images-section-header">
      <h3>Flat Images</h3>
      <p>Total Images: {{ galleryPictures().length }}</p>
    </header>
    @if (flatPicturesError()) {
      <p class="error-text">{{ flatPicturesError() }}</p>
    }
    @if (isLoadingFlatPictures()) {
      <section class="state-card">
        <div class="skeleton-block skeleton-line lg"></div>
        <div class="skeleton-block skeleton-image"></div>
      </section>
    }
    <div class="flat-images-list">
      @if (currentGalleryPicture(); as picture) {
        <div class="gallery-slider-shell">
          <div class="gallery-top-row">
            <p class="gallery-title">{{ picture.room_name }}</p>
            <p class="gallery-counter">{{ galleryIndex() + 1 }} / {{ galleryPictures().length }}</p>
          </div>
          <div class="flat-image-card">
            <button
              type="button"
              class="gallery-nav-btn gallery-nav-prev"
              (click)="goToPreviousGalleryPicture()"
              [disabled]="galleryPictures().length <= 1"
              aria-label="Previous image"
            >
              &#8249;
            </button>
            <div class="carousel-viewport">
              <div class="carousel-track" #flatCarouselList (scroll)="onGalleryScroll()">
                @for (slide of galleryPictures(); track slide.id; let idx = $index) {
                  <article class="carousel-slide" #flatCarouselSlide [class.active]="isGalleryPictureActive(idx)">
                    <img
                      class="flat-gallery-image clickable-image"
                      [src]="slide.picture_url"
                      [alt]="slide.room_name + ' image'"
                      (click)="openImageModal(slide.picture_url, slide.room_name)"
                    />
                  </article>
                }
              </div>
            </div>
            <button
              type="button"
              class="gallery-nav-btn gallery-nav-next"
              (click)="goToNextGalleryPicture()"
              [disabled]="galleryPictures().length <= 1"
              aria-label="Next image"
            >
              &#8250;
            </button>
          </div>
        </div>
        @if (galleryPictures().length > 1) {
          <div class="gallery-thumbs">
            @for (dot of galleryPictures(); track dot.id; let idx = $index) {
              <button
                type="button"
                class="gallery-thumb"
                [class.active]="isGalleryPictureActive(idx)"
                (click)="goToGalleryPicture(idx)"
                [attr.aria-label]="'Go to image ' + (idx + 1)"
              >
                <img [src]="dot.picture_url" [alt]="dot.room_name + ' thumbnail'" />
                <span>{{ dot.room_name }}</span>
              </button>
            }
          </div>
        }
      } @else {
        <article class="flat-image-card">
          @if (flat()?.picture_url) {
            <img
              class="flat-gallery-image clickable-image"
              [src]="flat()!.picture_url!"
              [alt]="(flat()?.flat_number ?? 'Flat') + ' image'"
              (click)="openImageModal(flat()!.picture_url!, flat()?.flat_number ?? 'Flat Image')"
            />
          } @else {
            <div class="flat-gallery-placeholder">No Flat Image</div>
          }
        </article>
      }
    </div>
  </section>

  <section class="amenities-section">
    <header class="section-header amenities-section-header">
      <h3>Amenities</h3>
      <p>Total Amenities: {{ amenities().length }}</p>
    </header>
    <div class="list-scroll-region">
      @if (amenities().length === 0 && !isLoading() && !error()) {
        <section class="state-card">
          <p>No amenities available for this flat.</p>
        </section>
      }

      <div class="amenities-list">
        @for (amenity of amenities(); track amenity.name + '-' + $index) {
          <article class="amenity-card">
            <h4 class="amenity-title">{{ amenity.name }}</h4>
            @if (amenity.picture_url) {
              <img class="amenity-image" [src]="amenity.picture_url" [alt]="amenity.name + ' image'" />
            } @else {
              <div class="amenity-image-placeholder">No Image</div>
            }
            <div
              class="amenity-content"
              role="button"
              tabindex="0"
              (click)="openAmenityModal(amenity)"
              (keydown.enter)="openAmenityModal(amenity)"
              (keydown.space)="openAmenityModal(amenity); $event.preventDefault()"
              aria-label="Open details for amenity {{ amenity.name }}"
            >
              <div class="amenity-meta-table">
                <p class="meta-full"><span>Description</span><strong>{{ amenity.description ?? 'No description provided.' }}</strong></p>
              </div>
            </div>
          </article>
        }
      </div>
    </div>
  </section>
</article>

@if (isBookingModalOpen()) {
  <section class="modal-backdrop" (click)="closeBookingModal()">
    <article class="booking-modal" (click)="$event.stopPropagation()">
      <header class="modal-header">
        <h3>Create Booking</h3>
        <button type="button" class="action-btn ghost" (click)="closeBookingModal()">Close</button>
      </header>
      <div class="modal-content">

      <p class="subtitle">Confirm booking for flat <strong>{{ flat()?.flat_number }}</strong>.</p>
      <p class="subtitle">Security deposit: <strong>{{ flat()?.security_deposit }}</strong></p>

      @if (bookingError()) {
        <p class="error-text">{{ bookingError() }}</p>
      }
      @if (bookingSuccess()) {
        <p class="success-text">{{ bookingSuccess() }}</p>
      }

      @if (bookingResponse()?.data; as booking) {
        <div class="booking-summary">
          <p><strong>Booking ID:</strong> {{ booking.id }}</p>
          <p><strong>Status:</strong> {{ booking.status }}</p>
          <p><strong>Created At:</strong> {{ booking.created_at ?? 'N/A' }}</p>
        </div>
      }

      <div class="modal-actions">
        <button type="button" class="action-btn primary" (click)="createBooking()" [disabled]="isBookingSubmitting() || !!bookingSuccess()">
          {{ bookingSuccess() ? 'Booking Done' : (isBookingSubmitting() ? 'Booking...' : 'Confirm Booking') }}
        </button>
      </div>
      </div>
    </article>
  </section>
}

@if (isAmenityModalOpen()) {
  <section class="modal-backdrop" (click)="closeAmenityModal()">
    <article class="booking-modal amenity-modal" (click)="$event.stopPropagation()">
      <header class="modal-header">
        <h3>Amenity Details</h3>
        <button type="button" class="action-btn ghost" (click)="closeAmenityModal()">Close</button>
      </header>
      <div class="modal-content">
      @if (selectedAmenity()) {
        <p class="subtitle"><strong>Building:</strong> {{ building()?.name ?? 'N/A' }}</p>
        @if (selectedAmenity()!.picture_url) {
          <img class="amenity-modal-image" [src]="selectedAmenity()!.picture_url!" [alt]="selectedAmenity()!.name + ' image'" />
        } @else {
          <div class="amenity-image-placeholder amenity-modal-placeholder">No Image</div>
        }
        <p class="subtitle"><strong>Name:</strong> {{ selectedAmenity()!.name }}</p>
        <p class="subtitle"><strong>Description:</strong> {{ selectedAmenity()!.description ?? 'No description provided.' }}</p>
      }
      </div>
    </article>
  </section>
}

