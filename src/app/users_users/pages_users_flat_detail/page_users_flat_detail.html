<article class="flat-detail-page">
  <header class="content-header">
    <div class="header-layout">
      <section class="header-info">
        <h2>{{ flat()?.flat_number ?? 'Flat' }}</h2>
        <p>
          Tower:
          <a class="entity-link" [routerLink]="['/users/buildings', buildingId(), 'towers', towerId()]">
            {{ tower()?.name ?? 'Tower' }}
          </a>
        </p>
        <p>
          Building:
          <a class="entity-link" [routerLink]="['/users/buildings', buildingId(), 'towers']">
            {{ building()?.name ?? 'Building' }}
          </a>
        </p>
        @if (building()) {
          <p class="flat-address">{{ building()!.full_address ?? (building()!.address + ', ' + building()!.city + ', ' + building()!.state + ', ' + building()!.pincode) }}</p>
        }
      </section>
      <div class="header-actions-block">
        <div class="header-meta-actions">
          <a
            class="action-btn ghost header-inline-btn"
            [routerLink]="['/users/buildings', buildingId(), 'towers', towerId()]"
            [attr.title]="'Back to ' + (tower()?.name ?? 'Tower')"
          >
            Back to <span class="back-label">{{ tower()?.name ?? 'Tower' }}</span>
          </a>
          <button
            type="button"
            class="action-btn primary header-inline-btn"
            (click)="openBookingModal()"
            [disabled]="flat()?.is_available === false || hasAlreadyBookedThisFlat()"
          >
            {{
              hasAlreadyBookedThisFlat()
                ? 'User Already Booked The Flat'
                : (flat()?.is_available === false ? 'Flat Not Available' : 'Book Flat')
            }}
          </button>
        </div>
      </div>
    </div>
  </header>

  @if (error()) {
    <section class="state-card error">
      <p>{{ error() }}</p>
    </section>
  }

  @if (isLoading()) {
    <section class="state-card">
      <div class="skeleton-block skeleton-line lg"></div>
      <div class="skeleton-block skeleton-line"></div>
      <div class="skeleton-block skeleton-image"></div>
    </section>
  }

  <section class="flat-images-section">
    <header class="section-header flat-images-section-header">
      <h3>Flat Images</h3>
      <p>Total Images: {{ flat()?.picture_url ? 1 : 0 }}</p>
    </header>
    <div class="flat-images-list">
      <article class="flat-image-card">
        @if (flat()?.picture_url) {
          <img class="flat-gallery-image" [src]="flat()!.picture_url!" [alt]="(flat()?.flat_number ?? 'Flat') + ' image'" />
        } @else {
          <div class="flat-gallery-placeholder">No Flat Image</div>
        }
      </article>
    </div>
  </section>

  <section class="amenities-section">
    <header class="section-header amenities-section-header">
      <h3>Amenities</h3>
      <p>Total Amenities: {{ amenities().length }}</p>
    </header>
    <div class="list-scroll-region">
      @if (amenities().length === 0 && !isLoading() && !error()) {
        <section class="state-card">
          <p>No amenities available for this flat.</p>
        </section>
      }

      <div class="amenities-list">
        @for (amenity of amenities(); track amenity.name + '-' + $index) {
          <article class="amenity-card">
            <h4 class="amenity-title">{{ amenity.name }}</h4>
            @if (amenity.picture_url) {
              <img class="amenity-image" [src]="amenity.picture_url" [alt]="amenity.name + ' image'" />
            } @else {
              <div class="amenity-image-placeholder">No Image</div>
            }
            <div
              class="amenity-content"
              role="button"
              tabindex="0"
              (click)="openAmenityModal(amenity)"
              (keydown.enter)="openAmenityModal(amenity)"
              (keydown.space)="openAmenityModal(amenity); $event.preventDefault()"
              aria-label="Open details for amenity {{ amenity.name }}"
            >
              <div class="amenity-meta-table">
                <p class="meta-full"><span>Description</span><strong>{{ amenity.description ?? 'No description provided.' }}</strong></p>
              </div>
            </div>
          </article>
        }
      </div>
    </div>
  </section>
</article>

@if (isBookingModalOpen()) {
  <section class="modal-backdrop" (click)="closeBookingModal()">
    <article class="booking-modal" (click)="$event.stopPropagation()">
      <header class="modal-header">
        <h3>Create Booking</h3>
        <button type="button" class="action-btn ghost" (click)="closeBookingModal()">Close</button>
      </header>
      <div class="modal-content">

      <p class="subtitle">Confirm booking for flat <strong>{{ flat()?.flat_number }}</strong>.</p>
      <p class="subtitle">Security deposit: <strong>{{ flat()?.security_deposit }}</strong></p>

      @if (bookingError()) {
        <p class="error-text">{{ bookingError() }}</p>
      }
      @if (bookingSuccess()) {
        <p class="success-text">{{ bookingSuccess() }}</p>
      }

      @if (bookingResponse()?.data; as booking) {
        <div class="booking-summary">
          <p><strong>Booking ID:</strong> {{ booking.id }}</p>
          <p><strong>Status:</strong> {{ booking.status }}</p>
          <p><strong>Created At:</strong> {{ booking.created_at ?? 'N/A' }}</p>
        </div>
      }

      <div class="modal-actions">
        <button type="button" class="action-btn primary" (click)="createBooking()" [disabled]="isBookingSubmitting() || !!bookingSuccess()">
          {{ bookingSuccess() ? 'Booking Done' : (isBookingSubmitting() ? 'Booking...' : 'Confirm Booking') }}
        </button>
      </div>
      </div>
    </article>
  </section>
}

@if (isAmenityModalOpen()) {
  <section class="modal-backdrop" (click)="closeAmenityModal()">
    <article class="booking-modal amenity-modal" (click)="$event.stopPropagation()">
      <header class="modal-header">
        <h3>Amenity Details</h3>
        <button type="button" class="action-btn ghost" (click)="closeAmenityModal()">Close</button>
      </header>
      <div class="modal-content">
      @if (selectedAmenity()) {
        <p class="subtitle"><strong>Building:</strong> {{ building()?.name ?? 'N/A' }}</p>
        @if (selectedAmenity()!.picture_url) {
          <img class="amenity-modal-image" [src]="selectedAmenity()!.picture_url!" [alt]="selectedAmenity()!.name + ' image'" />
        } @else {
          <div class="amenity-image-placeholder amenity-modal-placeholder">No Image</div>
        }
        <p class="subtitle"><strong>Name:</strong> {{ selectedAmenity()!.name }}</p>
        <p class="subtitle"><strong>Description:</strong> {{ selectedAmenity()!.description ?? 'No description provided.' }}</p>
      }
      </div>
    </article>
  </section>
}
