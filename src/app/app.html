<main class="app-shell">
  @if (hasSession()) {
    <header class="auth-global-header">
      <div class="auth-header-inner">
        <div class="brand-block">
          <h1>KOTS Rental Application</h1>
          <p>Authenticated Workspace</p>
        </div>

        <div class="auth-header-actions">
          <button type="button" class="header-btn home-btn" (click)="openSearchModal()" aria-label="Search" title="Search" style="display:inline-flex;align-items:center;justify-content:center;">
            <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true" focusable="false">
              <path fill="currentColor" d="M10 4a6 6 0 1 0 3.87 10.58l4.27 4.27 1.41-1.41-4.27-4.27A6 6 0 0 0 10 4m0 2a4 4 0 1 1 0 8 4 4 0 0 1 0-8" />
            </svg>
          </button>
          <a class="header-btn home-btn" routerLink="/home" routerLinkActive="active-nav-btn" [routerLinkActiveOptions]="{ exact: true }" style="display:inline-flex;align-items:center;">
            <svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true" focusable="false" style="margin-right:0.32rem;display:block;">
              <path fill="currentColor" d="M12 3 2 12h3v8h6v-5h2v5h6v-8h3z" />
            </svg>
            Home
          </a>
          <a class="header-btn" routerLink="/users/bookings" routerLinkActive="active-nav-btn" style="display:inline-flex;align-items:center;">
            <svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true" focusable="false" style="margin-right:0.32rem;display:block;">
              <path fill="currentColor" d="M7 2v2H5a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2V2h-2v2H9V2zm12 7H5v10h14z" />
            </svg>
            Bookings
          </a>
          <div class="user-chip">
            <div class="user-inline-row">
              <span class="email">{{ displayEmail() }}</span>
              @if (hasMasterAccess()) {
                <a class="role-nav-badge" style="margin-left:0.3rem;" routerLink="/master" routerLinkActive="active-role-nav-badge">MASTER</a>
              }
              @if (hasAdminAccess()) {
                <a class="role-nav-badge" style="margin-left:0.3rem;" routerLink="/admins" routerLinkActive="active-role-nav-badge">ADMIN</a>
              }
            </div>
          </div>
          <button type="button" class="avatar-btn" (click)="openProfileModal()" aria-label="Open profile details">
            @if (profileImageUrl(); as imageUrl) {
              <img class="header-avatar" [src]="imageUrl" alt="User profile picture" />
            } @else {
              <span class="avatar-fallback">{{ profileInitials() }}</span>
            }
          </button>
          <button type="button" class="header-btn logout-btn" (click)="logout()" [disabled]="isLoggingOut()">
            {{ isLoggingOut() ? 'Logging out...' : 'Logout' }}
          </button>
        </div>
      </div>
      <div class="global-loading-track" [class.active]="isGlobalLoading()">
        <div class="global-loading-runner"></div>
      </div>
    </header>
  }

  <section class="app-content" [class.with-auth-header]="hasSession()">
    @if (showRouteTransitionOverlay()) {
      <div class="route-transition-overlay" aria-hidden="true">
        <section class="route-welcome-grid">
          @for (item of [1, 2, 3]; track item) {
            <article class="route-welcome-card">
              <div class="skeleton-block skeleton-image"></div>
              <div class="skeleton-block skeleton-line lg"></div>
              <div class="skeleton-block skeleton-line"></div>
              <div class="skeleton-block skeleton-line"></div>
            </article>
          }
        </section>
      </div>
    }
    <router-outlet></router-outlet>
  </section>
</main>

@if (isProfileModalOpen()) {
  <section class="modal-backdrop" (click)="closeProfileModal()">
    <article class="profile-modal modal-shell" (click)="$event.stopPropagation()">
      <header class="modal-header">
        <h3>Profile & Account</h3>
        <button type="button" class="close-btn" (click)="closeProfileModal()">Close</button>
      </header>

      @if (userDataError()) {
        <p class="modal-error">{{ userDataError() }}</p>
      }

      <nav class="modal-tabs" aria-label="Profile tabs">
        <button
          type="button"
          class="tab-btn"
          [class.active]="activeModalTab() === 'profile'"
          (click)="setActiveModalTab('profile')"
        >
          Profile
        </button>
        <button
          type="button"
          class="tab-btn"
          [class.active]="activeModalTab() === 'account'"
          (click)="setActiveModalTab('account')"
        >
          Account
        </button>
      </nav>

      <div class="modal-body">
        @if (isLoadingUserData()) {
          <section class="table-section">
            <div class="section-card">
              <div class="skeleton-block skeleton-line lg"></div>
              <div class="skeleton-block skeleton-line"></div>
              <div class="skeleton-block skeleton-line"></div>
              <div class="skeleton-block skeleton-image"></div>
            </div>
          </section>
        }
        @if (activeModalTab() === 'profile') {
          <section class="table-section">
          <div class="section-card">
            <h4>Profile Picture</h4>
            <div class="profile-picture-panel">
              @if (profileImageUrl(); as imageUrl) {
                <img class="profile-image-large" [src]="imageUrl" alt="User profile picture" />
              } @else {
                <div class="profile-image-placeholder">{{ profileInitials() }}</div>
              }

              <div class="profile-picture-actions">
                <div class="profile-picture-controls-row">
                  <div class="upload-stack-box">
                    <div class="upload-field">
                      <label class="upload-trigger" for="profile-picture-upload">Choose File</label>
                      <input
                        id="profile-picture-upload"
                        class="upload-input-hidden"
                        type="file"
                        accept="image/*"
                        (change)="onProfilePictureFileSelected($event)"
                        [disabled]="isUpdatingProfilePicture()"
                      />
                    </div>
                    <button
                      type="button"
                      class="header-btn home-btn upload-stack-btn"
                      (click)="uploadSelectedProfilePicture()"
                      [disabled]="isUpdatingProfilePicture() || !selectedProfilePictureFile()"
                    >
                      {{ isUpdatingProfilePicture() ? 'Uploading...' : 'Upload Picture' }}
                    </button>
                  </div>
                  <button
                    type="button"
                    class="header-btn danger-accent-btn compact-danger-btn"
                    (click)="removeProfilePicture()"
                    [disabled]="isUpdatingProfilePicture()"
                  >
                    {{ isUpdatingProfilePicture() ? 'Processing...' : 'Remove Picture' }}
                  </button>
                </div>
                @if (selectedProfilePictureFile(); as selectedFile) {
                  <p class="selected-file upload-file-name">Selected: {{ selectedFile.name }}</p>
                }
                @if (selectedProfilePicturePreviewUrl(); as previewUrl) {
                  <div class="upload-preview-box">
                    <img class="upload-preview-image" [src]="previewUrl" alt="Selected profile preview" />
                  </div>
                }
              </div>
            </div>
          </div>

          @if (profilePictureActionError()) {
            <p class="modal-error">{{ profilePictureActionError() }}</p>
          }
          @if (profilePictureActionMessage()) {
            <p class="modal-success">{{ profilePictureActionMessage() }}</p>
          }

          <div class="section-card">
            <div class="table-header-row">
              <h4>Profile Details</h4>
              <div class="table-header-actions">
                <button type="button" class="header-btn home-btn" (click)="toggleProfileUpdateOpen()">
                  {{ isProfileUpdateOpen() ? 'Close Update Profile' : 'Update Profile' }}
                </button>
                <button type="button" class="header-btn danger-accent-btn" (click)="toggleProfileDeleteOpen()">
                  {{ isProfileDeleteOpen() ? 'Close Delete Profile' : 'Delete Profile' }}
                </button>
              </div>
            </div>
            @if (isProfileUpdateOpen()) {
              <div class="table-header-dropdown">
                <div class="profile-form-grid">
                  <label class="profile-field">
                    <span>Username</span>
                    <input
                      type="text"
                      [value]="profileFormUsername()"
                      (input)="setProfileFormUsername($any($event.target).value)"
                      [disabled]="isUpdatingProfileDetails()"
                    />
                  </label>
                  <label class="profile-field">
                    <span>Mobile Number</span>
                    <input
                      type="text"
                      [value]="profileFormMobileNumber()"
                      (input)="setProfileFormMobileNumber($any($event.target).value)"
                      [disabled]="isUpdatingProfileDetails()"
                    />
                  </label>
                  <label class="profile-field profile-field-full">
                    <span>Bio</span>
                    <textarea
                      rows="3"
                      [value]="profileFormBio()"
                      (input)="setProfileFormBio($any($event.target).value)"
                      [disabled]="isUpdatingProfileDetails()"
                    ></textarea>
                  </label>
                  <label class="profile-field">
                    <span>Date Of Birth (ISO)</span>
                    <input
                      type="text"
                      [value]="profileFormDateOfBirth()"
                      (input)="setProfileFormDateOfBirth($any($event.target).value)"
                      [disabled]="isUpdatingProfileDetails()"
                      placeholder="YYYY-MM-DDTHH:mm:ss"
                    />
                  </label>
                  <label class="profile-field">
                    <span>City</span>
                    <input
                      type="text"
                      [value]="profileFormCity()"
                      (input)="setProfileFormCity($any($event.target).value)"
                      [disabled]="isUpdatingProfileDetails()"
                    />
                  </label>
                  <label class="profile-field">
                    <span>State</span>
                    <input
                      type="text"
                      [value]="profileFormState()"
                      (input)="setProfileFormState($any($event.target).value)"
                      [disabled]="isUpdatingProfileDetails()"
                    />
                  </label>
                  <label class="profile-field">
                    <span>Country</span>
                    <input
                      type="text"
                      [value]="profileFormCountry()"
                      (input)="setProfileFormCountry($any($event.target).value)"
                      [disabled]="isUpdatingProfileDetails()"
                    />
                  </label>
                </div>
                <button
                  type="button"
                  class="header-btn home-btn"
                  (click)="updateProfileDetails()"
                  [disabled]="isUpdatingProfileDetails()"
                >
                  {{ isUpdatingProfileDetails() ? 'Saving...' : 'Save Profile Details' }}
                </button>
              </div>
            }
            @if (isProfileDeleteOpen()) {
              <div class="table-header-dropdown danger-table-dropdown">
                <p class="selected-file">Deleting profile will delete your account permanently.</p>
                <button
                  type="button"
                  class="header-btn danger-accent-btn"
                  (click)="deleteAccount()"
                  [disabled]="isUpdatingAccountDetails() || isDeletingAccount()"
                >
                  {{ isDeletingAccount() ? 'Deleting...' : 'Confirm Delete Profile' }}
                </button>
              </div>
            }
            <table class="details-table">
              <tbody>
                @for (row of profileRows(); track row[0]) {
                  <tr>
                    <th>{{ row[0] }}</th>
                    <td>{{ row[1] }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
          @if (profileDetailsActionError()) {
            <p class="modal-error">{{ profileDetailsActionError() }}</p>
          }
          @if (profileDetailsActionMessage()) {
            <p class="modal-success">{{ profileDetailsActionMessage() }}</p>
          }

          </section>
        } @else {
          <section class="table-section">
          <div class="section-card">
            <div class="table-header-row">
              <h4>Account Details</h4>
              <div class="table-header-actions">
                <button type="button" class="header-btn home-btn" (click)="toggleAccountUpdateOpen()">
                  {{ isAccountUpdateOpen() ? 'Close Update Account' : 'Update Account' }}
                </button>
                <button type="button" class="header-btn danger-accent-btn" (click)="toggleAccountDeleteOpen()">
                  {{ isAccountDeleteOpen() ? 'Close Delete Account' : 'Delete Account' }}
                </button>
              </div>
            </div>
            @if (isAccountUpdateOpen()) {
              <div class="table-header-dropdown">
                <div class="profile-form-grid">
                  <label class="profile-field">
                    <span>Email</span>
                    <input
                      type="email"
                      [value]="accountFormEmail()"
                      (input)="setAccountFormEmail($any($event.target).value)"
                      [disabled]="isUpdatingAccountDetails() || isDeletingAccount()"
                    />
                  </label>
                  <label class="profile-field">
                    <span>New Password</span>
                    <input
                      type="password"
                      [value]="accountFormPassword()"
                      (input)="setAccountFormPassword($any($event.target).value)"
                      [disabled]="isUpdatingAccountDetails() || isDeletingAccount()"
                      placeholder="Leave empty if not changing"
                    />
                  </label>
                </div>
                <button
                  type="button"
                  class="header-btn home-btn"
                  (click)="updateAccountDetails()"
                  [disabled]="isUpdatingAccountDetails() || isDeletingAccount()"
                >
                  {{ isUpdatingAccountDetails() ? 'Saving...' : 'Save Account Changes' }}
                </button>
              </div>
            }
            @if (isAccountDeleteOpen()) {
              <div class="table-header-dropdown danger-table-dropdown">
                <button
                  type="button"
                  class="header-btn danger-accent-btn"
                  (click)="deleteAccount()"
                  [disabled]="isUpdatingAccountDetails() || isDeletingAccount()"
                >
                  {{ isDeletingAccount() ? 'Deleting...' : 'Confirm Delete Account' }}
                </button>
              </div>
            }
            <table class="details-table">
              <tbody>
                @for (row of accountRows(); track row[0]) {
                  <tr>
                    <th>{{ row[0] }}</th>
                    <td>{{ row[1] }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>

          @if (accountActionError()) {
            <p class="modal-error">{{ accountActionError() }}</p>
          }
          @if (accountActionMessage()) {
            <p class="modal-success">{{ accountActionMessage() }}</p>
          }
          </section>
        }
      </div>
    </article>
  </section>
}

@if (isSearchModalOpen()) {
  <section class="modal-backdrop" (click)="closeSearchModal()">
    <article class="search-modal modal-shell" (click)="$event.stopPropagation()">
      <header class="modal-header">
        <h3>Search</h3>
        <button type="button" class="close-btn" (click)="closeSearchModal()">Close</button>
      </header>

      <nav class="modal-tabs search-mode-tabs" aria-label="Search mode tabs">
        <button
          type="button"
          class="tab-btn"
          [class.active]="globalSearchTab() === 'flat'"
          (click)="setGlobalSearchTab('flat')"
        >
          Flat
        </button>
        <button
          type="button"
          class="tab-btn"
          [class.active]="globalSearchTab() === 'building'"
          (click)="setGlobalSearchTab('building')"
        >
          Building
        </button>
      </nav>

      <div class="search-modal-grid">
        @if (globalSearchTab() === 'building') {
          <label class="profile-field">
            <span>Building Name</span>
            <input
              type="text"
              [value]="globalSearchBuildingName()"
              (input)="setGlobalSearchBuildingName($any($event.target).value)"
              placeholder="Skyline Residency"
            />
          </label>
        }
        <label class="profile-field">
          <span>Address</span>
          <input
            type="text"
            [value]="globalSearchAddress()"
            (input)="setGlobalSearchAddress($any($event.target).value)"
            placeholder="Madhapur"
          />
        </label>
        <label class="profile-field">
          <span>City</span>
          <input
            type="text"
            [value]="globalSearchCity()"
            (input)="setGlobalSearchCity($any($event.target).value)"
            placeholder="Hyderabad"
          />
        </label>
        <label class="profile-field">
          <span>State</span>
          <input
            type="text"
            [value]="globalSearchState()"
            (input)="setGlobalSearchState($any($event.target).value)"
            placeholder="Telangana"
          />
        </label>
        @if (globalSearchTab() === 'flat') {
          <label class="profile-field">
            <span>Flat Type</span>
            <input
              type="text"
              [value]="globalSearchFlatType()"
              (input)="setGlobalSearchFlatType($any($event.target).value)"
              placeholder="2BHK"
            />
          </label>
          <label class="profile-field">
            <span>Min Rent</span>
            <input
              type="number"
              min="0"
              [value]="globalSearchMinRent()"
              (input)="setGlobalSearchMinRent($any($event.target).value)"
              placeholder="15000"
            />
          </label>
          <label class="profile-field">
            <span>Max Rent</span>
            <input
              type="number"
              min="0"
              [value]="globalSearchMaxRent()"
              (input)="setGlobalSearchMaxRent($any($event.target).value)"
              placeholder="30000"
            />
          </label>
        }
      </div>

      <div class="search-modal-actions">
        <button type="button" class="header-btn" (click)="closeSearchModal()">Cancel</button>
        <button type="button" class="header-btn home-btn" (click)="submitGlobalFlatSearch()" aria-label="Search" title="Search" style="display:inline-flex;align-items:center;justify-content:center;">
          <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true" focusable="false">
            <path fill="currentColor" d="M10 4a6 6 0 1 0 3.87 10.58l4.27 4.27 1.41-1.41-4.27-4.27A6 6 0 0 0 10 4m0 2a4 4 0 1 1 0 8 4 4 0 0 1 0-8" />
          </svg>
        </button>
      </div>
    </article>
  </section>
}

@if (globalPreviewImageUrl(); as imageUrl) {
  <section class="global-image-preview-backdrop" (click)="closeGlobalImagePreview()">
    <article class="global-image-preview-shell" (click)="$event.stopPropagation()">
      <button type="button" class="close-btn" (click)="closeGlobalImagePreview()">Close</button>
      <img class="global-image-preview-full" [src]="imageUrl" alt="Full preview" />
    </article>
  </section>
}
